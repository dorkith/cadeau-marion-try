<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Password Game - Version Cryptique</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      transition: background-color 0.5s ease;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 0 8px #7ec8e3;
    }
    ul#rules {
      max-width: 700px;
      margin: 0 auto 30px auto;
      background: rgba(0,0,0,0.3);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 12px #004e7a;
      list-style: decimal inside;
      font-size: 1.1em;
      line-height: 1.4em;
    }
    #input-container {
      max-width: 600px;
      margin: 0 auto 20px auto;
      display: flex;
      gap: 10px;
    }
    #answer {
      flex-grow: 1;
      font-size: 1.2em;
      padding: 10px;
      border-radius: 6px;
      border: none;
      outline: none;
    }
    #submit {
      padding: 10px 20px;
      font-size: 1.2em;
      background-color: #42f5b9;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      color: #003022;
      font-weight: bold;
    }
    #submit:hover:not(:disabled) {
      background-color: #36c49d;
    }
    #submit:disabled {
      background-color: #777;
      cursor: default;
    }
    #message {
      text-align: center;
      font-size: 1.3em;
      margin-bottom: 10px;
      min-height: 2em;
    }
    #message.success {
      color: #7ef99f;
      text-shadow: 0 0 8px #4bc07d;
    }
    #message.error {
      color: #ff6b6b;
      text-shadow: 0 0 8px #d14040;
    }
    #stats {
      text-align: center;
      font-size: 1em;
      color: #aaddffcc;
      margin-top: 15px;
    }
    /* Flash red for error */
    .error-flash {
      animation: flashRed 0.9s;
    }
    @keyframes flashRed {
      0%, 100% { background-color: #1e3c72; }
      50% { background-color: #b22222; }
    }
    /* Flash green for success */
    .success-flash {
      animation: flashGreen 1.2s;
      box-shadow: 0 0 15px 4px #42f5b9 inset;
    }
    @keyframes flashGreen {
      0%, 100% { background-color: #1e3c72; }
      50% { background-color: #2ef59e; }
    }
  </style>
</head>
<body>
  <h1>The Password Game - Version Cryptique</h1>

  <ul id="rules"></ul>

  <div id="input-container">
    <input type="text" id="answer" placeholder="Tape ta réponse ici..." autocomplete="off" />
    <button id="submit">Valider</button>
  </div>

  <div id="message"></div>
  <div id="stats"></div>

  <script>
    (() => {
      const answerInput = document.getElementById("answer");
      const submitBtn = document.getElementById("submit");
      const messageDiv = document.getElementById("message");
      const rulesList = document.getElementById("rules");
      const statsDiv = document.getElementById("stats");

      const finalPhrase = "Félicitations, je t'offre un abonnement Médiapart.";

      const rules = [
        "La réponse doit commencer par une majuscule.",
        "La réponse doit contenir une apostrophe (').",
        "La réponse doit contenir une virgule (,).",
        "La phrase doit contenir exactement 6 mots.",
        "Le premier mot doit avoir au moins 8 lettres.",
        "La réponse doit contenir au moins 3 accents au total.",
        "Le dernier mot doit commencer par la lettre M.",
        "Le dernier mot doit avoir au moins 9 lettres.",
        "La phrase doit contenir une contraction (ex: t' ou d').",
        "La phrase doit contenir un mot avec une double lettre au milieu.",
        "Il doit y avoir au moins un mot qui finit par la lettre 't'.",
        "La phrase doit contenir un pronom personnel singulier.",
        "La phrase ne doit pas dépasser 500 caractères.",
        "Chaque mot doit contenir au moins une voyelle.",
        "La phrase doit contenir exactement 5 espaces.",
        "La phrase ne doit pas contenir la lettre 'z'.",
        "La première lettre du troisième mot doit être 't'.",
        "La phrase doit contenir au moins deux 'o'.",
        "Le deuxième mot doit être plus court que le premier.",
        "La phrase doit contenir le mot 'un'.",
        "Le dernier mot doit contenir au moins 3 voyelles.",
        "La phrase doit contenir au moins un accent circonflexe.",
        "La phrase ne doit pas commencer ni se terminer par un espace.",
        "Le mot avant le dernier doit commencer par la lettre 'a'.",
        "Le mot après la virgule doit commencer par la lettre 'j'.",
        "La phrase doit être exactement : 'Félicitations, je t'offre un abonnement Médiapart.'"
      ];

      let step = 0;
      let attempts = 0;
      const startTime = Date.now();

      function firstLetterIsUpper(str) {
        return /^[A-ZÀ-Ÿ]/.test(str.trim());
      }

      function containsApostrophe(str) {
        return str.includes("'");
      }

      function containsComma(str) {
        return str.includes(",");
      }

      function countWords(str) {
        return str.trim().split(/\s+/).length;
      }

      function firstWord(str) {
        return str.trim().split(/\s+/)[0];
      }

      function countAccents(str) {
        const accentsChars = "àáâäãåèéêëìíîïòóôöõùúûüÿç";
        let count = 0;
        for (let c of str.toLowerCase()) {
          if (accentsChars.includes(c)) count++;
        }
        return count;
      }

      function lastWord(str) {
        const words = str.trim().split(/\s+/);
        return words[words.length - 1];
      }

      function hasContraction(str) {
        return /(\bt'|\bd')/.test(str);
      }

      function hasDoubleLetterMiddle(str) {
        const words = str.trim().split(/\s+/);
        for (const w of words) {
          if (w.length >= 4) {
            for (let i = 1; i < w.length - 2; i++) {
              if (w[i] === w[i + 1]) return true;
            }
          }
        }
        return false;
      }

      function endsWithLetterT(str) {
        const words = str.trim().split(/\s+/);
        return words.some(w => w.endsWith("t") || w.endsWith("T"));
      }

      function hasPersonalPronoun(str) {
        const pronouns = ["je", "tu", "il", "elle", "on", "moi", "toi", "lui", "me", "te"];
        const words = str.toLowerCase().trim().split(/\s+/);
        return pronouns.some(p => words.includes(p));
      }

      function maxLength500(str) {
        return str.length <= 500;
      }

      function allWordsHaveVowels(str) {
        const vowels = /[aeiouyàáâãäåèéêëìíîïòóôõöùúûüÿ]/i;
        const words = str.trim().split(/\s+/);
        return words.every(w => vowels.test(w));
      }

      function countSpaces(str) {
        return (str.match(/ /g) || []).length;
      }

      function noLetterZ(str) {
        return !/[zZ]/.test(str);
      }

      function thirdWordStartsWithT(str) {
        const words = str.trim().split(/\s+/);
        if (words.length < 3) return false;
        return words[2][0].toLowerCase() === "t";
      }

      function containsAtLeastTwoO(str) {
        return (str.match(/o/gi) || []).length >= 2;
      }

      function secondWordShorterThanFirst(str) {
        const words = str.trim().split(/\s+/);
        if (words.length < 2) return false;
        return words[1].length < words[0].length;
      }

      function containsWordUn(str) {
        return /\bun\b/i.test(str);
      }

      function lastWordHasAtLeast3Vowels(str) {
        const w = lastWord(str).toLowerCase();
        const vowels = w.match(/[aeiouyàáâãäåèéêëìíîïòóôõöùúûüÿ]/gi) || [];
        return vowels.length >= 3;
      }

      function containsCircumflexAccent(str) {
        return /[\^êâîôû]/i.test(str);
      }

      function noSpaceAtStartOrEnd(str) {
        return str === str.trim();
      }

      function penultimateWordStartsWithA(str) {
        const words = str.trim().split(/\s+/);
        if (words.length < 2) return false;
        return words[words.length - 2][0].toLowerCase() === "a";
      }

      function wordAfterCommaStartsWithJ(str) {
        const idx = str.indexOf(",");
        if (idx === -1) return false;
        const afterComma = str.slice(idx + 1).trim();
        if (!afterComma) return false;
        return afterComma[0].toLowerCase() === "j";
      }

      function isFinalPhrase(str) {
        return str.trim() === finalPhrase;
      }

      const validators = [
        firstLetterIsUpper,
        containsApostrophe,
        containsComma,
        (s) => countWords(s) === 6,
        (s) => firstWord(s).length >= 8,
        (s) => countAccents(s) >= 3, // règle modifiée ici : au moins 3 accents au total
        (s) => lastWord(s).toLowerCase().startsWith("m"),
        (s) => lastWord(s).length >= 9,
        hasContraction,
        hasDoubleLetterMiddle,
        endsWithLetterT,
        hasPersonalPronoun,
        maxLength500, // règle 13 modifiée ici pour limiter à 500 caractères max
        allWordsHaveVowels,
        (s) => countSpaces(s) === 5,
        noLetterZ,
        thirdWordStartsWithT,
        containsAtLeastTwoO,
        secondWordShorterThanFirst,
        containsWordUn,
        lastWordHasAtLeast3Vowels,
        containsCircumflexAccent,
        noSpaceAtStartOrEnd,
        penultimateWordStartsWithA,
        wordAfterCommaStartsWithJ,
        isFinalPhrase,
      ];

      function renderAllRules() {
        rulesList.innerHTML = "";
        const li = document.createElement("li");
        li.textContent = rules[step];
        rulesList.appendChild(li);
      }

      function showMessage(text, type = "error") {
        messageDiv.textContent = text;
        messageDiv.className = "";
        if (type === "error") {
          messageDiv.classList.add("error");
          flashError();
        } else if (type === "success") {
          messageDiv.classList.add("success");
          flashSuccess();
        }
      }

      function flashError() {
        document.body.classList.remove("error-flash");
        void document.body.offsetWidth;
        document.body.classList.add("error-flash");
        playErrorSound();
      }

      function flashSuccess() {
        document.body.classList.remove("success-flash");
        void document.body.offsetWidth;
        document.body.classList.add("success-flash");
        playSuccessSound();
      }

      function playErrorSound() {
        const context = new AudioContext();
        const oscillator = context.createOscillator();
        oscillator.type = "square";
        oscillator.frequency.setValueAtTime(200, context.currentTime);
        oscillator.connect(context.destination);
        oscillator.start();
        oscillator.stop(context.currentTime + 0.2);
      }

      function playSuccessSound() {
        const context = new AudioContext();
        const oscillator = context.createOscillator();
        oscillator.type = "triangle";
        oscillator.frequency.setValueAtTime(440, context.currentTime);
        oscillator.connect(context.destination);
        oscillator.start();
        oscillator.stop(context.currentTime + 0.3);
      }

      function launchConfetti() {
        const colors = ['#ff0a54','#ff477e','#ff85a1','#fbb1b1','#f9bec7'];
        for (let i = 0; i < 100; i++) {
          const confetti = document.createElement("div");
          confetti.classList.add("confetti-piece");
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.left = Math.random() * window.innerWidth + "px";
          confetti.style.top = -10 + "px";
          confetti.style.animationDuration = (2 + Math.random() * 3) + "s";
          confetti.style.animationDelay = (Math.random() * 2) + "s";
          confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
          document.body.appendChild(confetti);
          confetti.addEventListener("animationend", () => {
            confetti.remove();
          });
        }
      }

      function updateStats() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        statsDiv.textContent = `Règle ${step + 1} / ${rules.length} | Tentatives : ${attempts} | Temps écoulé : ${elapsed}s`;
      }

      function checkAnswer(input) {
        const valid = validators[step](input);
        if (valid) {
          showMessage("Bravo, règle validée !", "success");
          step++;
          if (step === rules.length) {
            showMessage("🎉 Vous avez terminé toutes les règles ! 🎉", "success");
            answerInput.disabled = true;
            submitBtn.disabled = true;
            launchConfetti();
          } else {
            renderAllRules();
          }
          updateStats();
          answerInput.value = "";
          answerInput.focus();
        } else {
          attempts++;
          showMessage("Ce n'est pas la bonne réponse pour cette règle.", "error");
          updateStats();
        }
      }

      renderAllRules();
      updateStats();

      submitBtn.addEventListener("click", () => {
        const val = answerInput.value.trim();
        if (val.length === 0) {
          showMessage("Merci de saisir une réponse.", "error");
          return;
        }
        checkAnswer(val);
      });

      answerInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          submitBtn.click();
        }
      });
    })();
  </script>
</body>
</html>
