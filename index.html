<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Password Game - M√©diapart</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f5f5f5; }
    h1 { font-size: 2rem; }
    #rule { font-weight: bold; margin-bottom: 1rem; }
    #inputZone { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
    #message { min-height: 1rem; margin-top: 0.5rem; }
    #progress { margin: 1rem 0; font-weight: bold; }
    #miniGameContainer img.img-blur { filter: blur(5px); height: 100px; }
    #dragList { list-style: none; padding: 0; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    #dragList li { background: white; padding: 0.5rem; border: 1px solid #ccc; cursor: grab; }
    li.dragging { opacity: 0.5; }
    li.over { border-color: blue; }
  </style>
</head>
<body>
  <h1>Password Game - M√©diapart Edition</h1>
  <div id="rule"></div>
  <div id="inputZone">
    <input type="text" id="answer" placeholder="Tape ta phrase ici...">
    <button id="submit">Valider</button>
  </div>
  <div id="progress"></div>
  <div id="message"></div>
  <div id="miniGameContainer"></div>
  <button id="start">Commencer</button>

  <script>
    const rules = [
      { text: "Ta phrase doit contenir le mot 'abonnement'.", test: input => input.toLowerCase().includes("abonnement"), emoji: "üì©" },
      { text: "Elle doit comporter au moins 3 mots.", test: input => input.trim().split(/\s+/).length >= 3, emoji: "üî§" },
      { text: "Elle doit commencer par 'F√©licitation'.", test: input => input.trim().startsWith("F√©licitation"), emoji: "üéâ" },
      { text: "Elle doit contenir un mot en majuscules.", test: input => /\b[A-Z]{2,}\b/.test(input), emoji: "üî†" },
      { text: "Elle doit contenir un emoji.", test: input => /\p{Emoji}/u.test(input), emoji: "üòä" },
      { text: "Un mot doit rimer avec 'art'.", test: input => input.split(/\s+/).some(m => /art$/.test(m.toLowerCase())), emoji: "üéµ" },
      { text: "Elle doit inclure la date du jour.", test: input => input.includes(new Date().toLocaleDateString('fr-FR')), emoji: "üìÖ" },
      { text: "Elle doit inclure un chiffre impair.", test: input => /\b[13579]\b/.test(input), emoji: "üî¢" },
      { text: "Mot acrostiche de 'abonnement'.", miniGame: "acrostiche", emoji: "üî°" },
      { text: "Le mot 'offre' doit √™tre chiffr√© en C√©sar +1.", miniGame: "cesar", emoji: "üîê" },
      { text: "Reconnaissance d'image : quelle lettre est flout√©e ?", miniGame: "image", emoji: "üñºÔ∏è" },
      { text: "Incline ton t√©l√©phone vers la droite.", miniGame: "inclinaison", emoji: "üì±" },
      { text: "R√©ordonne les mots de la phrase correctement.", miniGame: "dragdrop", emoji: "üß©" },
      { text: "Devine le mot prononc√©.", miniGame: "audio", emoji: "üîä" },
      { text: "Challenge chronom√©tr√© : r√©ponds en moins de 3 minutes !", test: () => true, emoji: "‚è±Ô∏è" }
    ];

    let step = 0;
    let attempts = 0;
    let totalRules = rules.length;
    let bonusChallengeActive = false;
    let bonusSuccess = false;
    let chronoTimeout;

    const ruleDiv = document.getElementById('rule');
    const answerInput = document.getElementById('answer');
    const submitBtn = document.getElementById('submit');
    const progressDiv = document.getElementById('progress');
    const messageDiv = document.getElementById('message');
    const miniGameContainer = document.getElementById('miniGameContainer');
    const startBtn = document.getElementById('start');

    function updateProgress() {
      progressDiv.textContent = `R√®gle ${step + 1} / ${totalRules}`;
    }

    function startChrono(seconds, callback) {
      chronoTimeout = setTimeout(callback, seconds * 1000);
    }
    function stopChrono() {
      clearTimeout(chronoTimeout);
    }

    function miniGameAcrostiche(input) {
      const acro = input.trim().split(/\s+/).map(w => w[0]).join('').toLowerCase();
      return acro.includes('abonnement');
    }
    function miniGameCesar(input) {
      function cesar(m) {
        return m.split('').map(c => c === 'z' ? 'a' : String.fromCharCode(c.charCodeAt(0) + 1)).join('');
      }
      return input.toLowerCase().split(/\s+/).includes(cesar("offre"));
    }
    async function miniGameImage() {
      miniGameContainer.innerHTML = `<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4a/Fleur_de_lys_noir_et_blanc.svg/120px-Fleur_de_lys_noir_et_blanc.svg.png" class="img-blur"><input id="imgGuess"><button id="imgGuessBtn">Valider</button><div id="imgMsg"></div>`;
      return new Promise(resolve => {
        document.getElementById('imgGuessBtn').onclick = () => {
          const val = document.getElementById('imgGuess').value.toUpperCase();
          if(val === 'F') {
            miniGameContainer.innerHTML = "";
            resolve(true);
          } else {
            document.getElementById('imgMsg').textContent = "‚ùå";
            resolve(false);
          }
        };
      });
    }
    async function miniGameInclinaison() {
      miniGameContainer.innerHTML = `<button id="tiltRightBtn">Incliner √† droite</button><div id="tiltMsg"></div>`;
      return new Promise(resolve => {
        document.getElementById('tiltRightBtn').onclick = () => {
          miniGameContainer.innerHTML = "";
          resolve(true);
        };
      });
    }
    async function miniGameDragDrop() {
      const phrase = "F√©licitation je t'offre un abonnement M√©diapart";
      const mots = phrase.split(' ').sort(() => Math.random() - 0.5);
      miniGameContainer.innerHTML = `<ul id="dragList">${mots.map(w => `<li draggable="true">${w}</li>`).join('')}</ul><button id="validerDrag">Valider</button><div id="dragMsg"></div>`;
      const dragList = document.getElementById('dragList');
      let dragSrc;
      dragList.querySelectorAll('li').forEach(li => {
        li.ondragstart = e => { dragSrc = li; e.dataTransfer.setData('text', li.innerHTML); };
        li.ondrop = e => { e.preventDefault(); [dragSrc.innerHTML, li.innerHTML] = [li.innerHTML, dragSrc.innerHTML]; };
        li.ondragover = e => e.preventDefault();
      });
      return new Promise(resolve => {
        document.getElementById('validerDrag').onclick = () => {
          const ordre = [...dragList.children].map(li => li.textContent).join(' ');
          if(ordre === phrase) {
            miniGameContainer.innerHTML = "";
            resolve(true);
          } else {
            document.getElementById('dragMsg').textContent = "‚ùå Mauvais ordre";
            resolve(false);
          }
        };
      });
    }
    async function miniGameAudio() {
      miniGameContainer.innerHTML = `<p>Devine le mot entendu : 'F√©licitation'</p><input id="audioGuess"><button id="audioBtn">Valider</button><div id="audioMsg"></div>`;
      return new Promise(resolve => {
        document.getElementById('audioBtn').onclick = () => {
          const val = document.getElementById('audioGuess').value.toLowerCase();
          if(val === 'f√©licitation' || val === 'felicitation') {
            miniGameContainer.innerHTML = "";
            resolve(true);
          } else {
            document.getElementById('audioMsg').textContent = "‚ùå";
            resolve(false);
          }
        };
      });
    }

    function showRuleText(rule) {
      ruleDiv.textContent = `${rule.emoji || ''} ${rule.text}`;
    }
    async function testRule(rule, input) {
      if(rule.test) return rule.test(input);
      if(rule.miniGame === "acrostiche") return miniGameAcrostiche(input);
      if(rule.miniGame === "cesar") return miniGameCesar(input);
      if(rule.miniGame === "image") return await miniGameImage();
      if(rule.miniGame === "inclinaison") return await miniGameInclinaison();
      if(rule.miniGame === "dragdrop") return await miniGameDragDrop();
      if(rule.miniGame === "audio") return await miniGameAudio();
      return true;
    }

    async function nextStep() {
      attempts = 0;
      if(step >= totalRules) {
        messageDiv.textContent = "üéâ Bravo, tu as termin√© !";
        answerInput.disabled = true;
        submitBtn.disabled = true;
        stopChrono();
        return;
      }
      showRuleText(rules[step]);
      updateProgress();
      answerInput.value = "";
      miniGameContainer.innerHTML = "";

      if(step === 14) {
        bonusChallengeActive = true;
        startChrono(180, () => {
          if(!bonusSuccess) {
            messageDiv.textContent = "‚è∞ Temps √©coul√© ! Essaie encore.";
          }
          bonusChallengeActive = false;
        });
      } else {
        if(bonusChallengeActive) stopChrono();
      }
    }

    submitBtn.onclick = async () => {
      let input = answerInput.value.trim();
      if(!input) return;
      let ok = await testRule(rules[step], input);
      if(ok) {
        bonusSuccess = true;
        step++;
        await nextStep();
        messageDiv.textContent = "‚úÖ Bien jou√© !";
      } else {
        messageDiv.textContent = "‚ùå Essaie encore.";
      }
    };

    startBtn.onclick = () => {
      startBtn.disabled = true;
      nextStep();
    };

    answerInput.addEventListener("keyup", e => { if(e.key === "Enter") submitBtn.click(); });
  </script>
</body>
</html>
