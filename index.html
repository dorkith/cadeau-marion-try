<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jeu mot de passe cryptique</title>
<style>
  body {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    color: #e0e0e0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0; min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
  }
  h1 {
    margin: 1rem 0 0.5rem;
    color: #ffd369;
    text-shadow: 0 0 6px #f0c040;
  }
  #rulesContainer {
    width: 90%;
    max-width: 600px;
    background: #0f3460;
    border-radius: 10px;
    padding: 15px 20px;
    margin: 10px 0 20px;
    box-shadow: 0 0 15px #0f3460;
    max-height: 400px;
    overflow-y: auto;
  }
  .rule-item {
    margin-bottom: 12px;
    font-size: 1rem;
    line-height: 1.3;
    color: #cfd8dc;
  }
  .rule-item.current {
    color: #f0c040;
    font-weight: 700;
  }
  #inputArea {
    display: flex;
    width: 90%;
    max-width: 600px;
    margin-bottom: 15px;
  }
  #answerInput {
    flex-grow: 1;
    font-size: 1.1rem;
    padding: 10px 12px;
    border-radius: 8px 0 0 8px;
    border: none;
    outline: none;
    box-shadow: 0 0 6px #f0c040 inset;
    background: #16213e;
    color: #fff;
  }
  #submitBtn {
    background: #f0c040;
    border: none;
    padding: 10px 18px;
    font-weight: 700;
    cursor: pointer;
    border-radius: 0 8px 8px 0;
    box-shadow: 0 0 10px #f0c040;
    transition: background 0.3s ease;
  }
  #submitBtn:hover:not(:disabled) {
    background: #ffde59;
  }
  #submitBtn:disabled {
    background: #aaa;
    cursor: not-allowed;
    box-shadow: none;
  }
  #message {
    font-size: 1.2rem;
    min-height: 2em;
    margin-bottom: 10px;
    text-align: center;
  }
  #message.success {
    color: #4caf50;
    text-shadow: 0 0 8px #4caf50;
  }
  #message.error {
    color: #e74c3c;
    text-shadow: 0 0 8px #e74c3c;
  }
  #stats {
    font-size: 0.9rem;
    color: #aaa;
    margin-bottom: 30px;
  }
  /* Animation confetti */
  .confetti-piece {
    position: fixed;
    width: 8px; height: 8px;
    background-color: #f0c040;
    opacity: 0.9;
    z-index: 9999;
    pointer-events: none;
    animation-name: fallConfetti;
    animation-timing-function: ease-out;
    animation-iteration-count: 1;
  }
  @keyframes fallConfetti {
    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
  }

  /* Feedback écran */
  body.error-flash {
    animation: flashRed 0.3s 3;
  }
  @keyframes flashRed {
    0%,100% { background-color: #1a1a2e; }
    50% { background-color: #9b1c1c; }
  }
  body.success-flash {
    box-shadow: 0 0 20px 6px #4caf50 inset;
    animation: glowGreen 0.5s ease forwards;
  }
  @keyframes glowGreen {
    from { box-shadow: none; }
    to { box-shadow: 0 0 30px 10px #4caf50 inset; }
  }
</style>
</head>
<body>
  <h1>Jeu mot de passe cryptique</h1>
  <div id="rulesContainer"></div>
  <div id="inputArea">
    <input type="text" id="answerInput" autocomplete="off" placeholder="Écris ta réponse ici..." />
    <button id="submitBtn">Valider</button>
  </div>
  <div id="message"></div>
  <div id="stats"></div>

<script>
// Sons (usage Web Audio API simple)
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playTone(freq, duration = 150) {
  const oscillator = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  oscillator.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  oscillator.type = 'triangle';
  oscillator.frequency.value = freq;
  oscillator.start();
  gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration / 1000);
  oscillator.stop(audioCtx.currentTime + duration / 1000);
}

function playSuccessSound() {
  playTone(440, 200);
  setTimeout(() => playTone(660, 150), 200);
}
function playErrorSound() {
  playTone(150, 200);
  setTimeout(() => playTone(100, 150), 200);
}

(function() {
  const finalPhrase = "Félicitations, je t'offre un abonnement Médiapart.";
  const rules = [
    "Ta réponse doit commencer par une majuscule.",
    "Ta réponse doit contenir une apostrophe (').",
    "Ta réponse doit contenir une virgule (,).",
    "Ta réponse doit contenir exactement 6 mots.",
    "Le premier mot doit avoir au moins 8 lettres.",
    "La réponse doit contenir au moins 3 accents différents (é, è, ê, ë, à, â, ä, î, ï, ô, ö, ù, û, ü).",
    "Le dernier mot doit commencer par la lettre M.",
    "Le dernier mot doit faire au moins 9 lettres.",
    "Ta réponse doit contenir au moins une contraction (comme \"t'\" ou \"d'\").",
    "Il doit y avoir au moins un mot avec une double lettre consécutive au milieu (ex: 'abonnement').",
    "Il doit y avoir au moins un mot qui finit par la lettre 't'.",
    "La phrase doit contenir un pronom personnel singulier (je, tu, il, elle, on, me, te, se, lui).",
    "Le nombre total de caractères (espaces inclus) doit être entre 37 et 43.",
    "Chaque mot doit contenir au moins une voyelle.",
    "Il doit y avoir exactement 5 espaces dans la phrase.",
    "La phrase ne doit pas contenir la lettre 'z'.",
    "La première lettre du troisième mot doit être 't'.",
    "La phrase doit contenir la lettre 'o' au moins deux fois.",
    "Le deuxième mot doit être plus court que le premier.",
    "Le mot 'un' doit être présent dans la phrase.",
    "Le dernier mot doit contenir au moins 3 voyelles.",
    "Il doit y avoir au moins un mot avec un accent circonflexe (â, ê, î, ô, û).",
    "La phrase ne doit pas commencer ni se terminer par un espace.",
    "Le mot avant le dernier doit commencer par la lettre 'a'.",
    "Le mot après la virgule doit commencer par 'j'.",
    "La phrase finale doit correspondre exactement à la phrase à deviner."
  ];

  let step = 0;
  let attempts = 0;
  let startTime = Date.now();

  const rulesContainer = document.getElementById("rulesContainer");
  const answerInput = document.getElementById("answerInput");
  const submitBtn = document.getElementById("submitBtn");
  const messageDiv = document.getElementById("message");
  const statsDiv = document.getElementById("stats");

  // Fonctions utilitaires
  function countWords(str) {
    return str.trim().split(/\s+/).length;
  }
  function countLetter(str, letter) {
    return (str.match(new RegExp(letter, "gi")) || []).length;
  }
  function containsApostrophe(str) {
    return /'/.test(str);
  }
  function containsComma(str) {
    return /,/.test(str);
  }
  function countAccents(str) {
    const accents = str.match(/[éèêëàâäîïôöùûü]/gi) || [];
    return new Set(accents.map(a => a.toLowerCase())).size;
  }
  function firstLetterIsUpper(str) {
    return /^[A-ZÀÂÄÇÉÈÊËÏÎÔÖÙÛÜÆŒ]/.test(str);
  }
  function lastWord(str) {
    const words = str.trim().split(/\s+/);
    return words[words.length -1];
  }
  function firstWord(str) {
    return str.trim().split(/\s+/)[0];
  }
  function hasContraction(str) {
    return /\b\w'/.test(str);
  }
  function hasDoubleLetterMiddle(str) {
    const words = str.trim().split(/\s+/);
    for(let w of words) {
      if(w.length >= 4) {
        for(let i = 1; i < w.length-2; i++) {
          if(w[i] === w[i+1]) return true;
        }
      }
    }
    return false;
  }
  function endsWithLetterT(str) {
    return /\b\w*t\b/i.test(str);
  }
  function hasPersonalPronoun(str) {
    return /\b(je|tu|il|elle|on|me|te|se|lui)\b/i.test(str);
  }
  function eachWordHasVowel(str) {
    return str.trim().split(/\s+/).every(w => /[aeiouyàâäéèêëîïôöùûü]/i.test(w));
  }
  function hasExactSpaces(str, n) {
    return (str.split(" ").length - 1) === n;
  }
  function noZLetter(str) {
    return !/[zZ]/.test(str);
  }
  function thirdWordStartsWithT(str) {
    const w = str.trim().split(/\s+/)[2];
    return w && w[0].toLowerCase() === "t";
  }
  function hasAtLeastTwoOs(str) {
    return countLetter(str, "o") >= 2;
  }
  function secondWordShorterThanFirst(str) {
    const words = str.trim().split(/\s+/);
    return words[1].length < words[0].length;
  }
  function containsWordUn(str) {
    return /\bun\b/.test(str);
  }
  function lastWordHasMinVowels(str, min) {
    const vowels = str.match(/[aeiouyàâäéèêëîïôöùûü]/gi) || [];
    const last = lastWord(str);
    const count = (last.match(/[aeiouyàâäéèêëîïôöùûü]/gi) || []).length;
    return count >= min;
  }
  function hasWordWithCircumflex(str) {
    return /[âêîôû]/i.test(str);
  }
  function noExtraSpacesEdges(str) {
    return str.trim() === str;
  }
  function penultimateWordStartsWithA(str) {
    const words = str.trim().split(/\s+/);
    if(words.length < 2) return false;
    return words[words.length - 2][0].toLowerCase() === "a";
  }
  function wordAfterCommaStartsWithJ(str) {
    const afterComma = str.split(",")[1];
    if(!afterComma) return false;
    return afterComma.trim()[0].toLowerCase() === "j";
  }

  function validateAnswer(ans) {
    ans = ans.trim();

    // Impose toutes les règles précédentes et la règle actuelle cumulativement :
    // Chaque règle est validée uniquement si toutes les précédentes aussi sont vraies.

    for(let i=0; i <= step; i++) {
      switch(i) {
        case 0:
          if(!firstLetterIsUpper(ans)) return {ok:false, error:"La réponse doit commencer par une majuscule."};
          break;
        case 1:
          if(!containsApostrophe(ans)) return {ok:false, error:"La réponse doit contenir une apostrophe (')."};
          break;
        case 2:
          if(!containsComma(ans)) return {ok:false, error:"La réponse doit contenir une virgule (,)."};
          break;
        case 3:
          if(countWords(ans) !== 6) return {ok:false, error:"La phrase doit contenir exactement 6 mots."};
          break;
        case 4:
          if(firstWord(ans).length < 8) return {ok:false, error:"Le premier mot doit avoir au moins 8 lettres."};
          break;
        case 5:
          if(countAccents(ans) < 3) return {ok:false, error:"La réponse doit contenir au moins 3 accents différents."};
          break;
        case 6:
          if(lastWord(ans)[0].toLowerCase() !== "m") return {ok:false, error:"Le dernier mot doit commencer par la lettre M."};
          break;
        case 7:
          if(lastWord(ans).length < 9) return {ok:false, error:"Le dernier mot doit avoir au moins 9 lettres."};
          break;
        case 8:
          if(!hasContraction(ans)) return {ok:false, error:"La phrase doit contenir une contraction (ex: t' ou d')."};
          break;
        case 9:
          if(!hasDoubleLetterMiddle(ans)) return {ok:false, error:"La phrase doit contenir un mot avec une double lettre au milieu."};
          break;
        case 10:
          if(!endsWithLetterT(ans)) return {ok:false, error:"Il doit y avoir au moins un mot qui finit par la lettre 't'."};
          break;
        case 11:
          if(!hasPersonalPronoun(ans)) return {ok:false, error:"La phrase doit contenir un pronom personnel singulier."};
          break;
        case 12:
          if(ans.length < 37 || ans.length > 43) return {ok:false, error:"La phrase doit contenir entre 37 et 43 caractères."};
          break;
        case 13:
          if(!eachWordHasVowel(ans)) return {ok:false, error:"Chaque mot doit contenir au moins une voyelle."};
          break;
        case 14:
          if(!hasExactSpaces(ans, 5)) return {ok:false, error:"La phrase doit contenir exactement 5 espaces."};
          break;
        case 15:
          if(!noZLetter(ans)) return {ok:false, error:"La phrase ne doit pas contenir la lettre 'z'."};
          break;
        case 16:
          if(!thirdWordStartsWithT(ans)) return {ok:false, error:"La première lettre du troisième mot doit être 't'."};
          break;
        case 17:
          if(!hasAtLeastTwoOs(ans)) return {ok:false, error:"La phrase doit contenir au moins deux 'o'."};
          break;
        case 18:
          if(!secondWordShorterThanFirst(ans)) return {ok:false, error:"Le deuxième mot doit être plus court que le premier."};
          break;
        case 19:
          if(!containsWordUn(ans)) return {ok:false, error:"La phrase doit contenir le mot 'un'."};
          break;
        case 20:
          if(!lastWordHasMinVowels(ans, 3)) return {ok:false, error:"Le dernier mot doit contenir au moins 3 voyelles."};
          break;
        case 21:
          if(!hasWordWithCircumflex(ans)) return {ok:false, error:"La phrase doit contenir au moins un accent circonflexe."};
          break;
        case 22:
          if(!noExtraSpacesEdges(ans)) return {ok:false, error:"La phrase ne doit pas commencer ni se terminer par un espace."};
          break;
        case 23:
          if(!penultimateWordStartsWithA(ans)) return {ok:false, error:"Le mot avant le dernier doit commencer par la lettre 'a'."};
          break;
        case 24:
          if(!wordAfterCommaStartsWithJ(ans)) return {ok:false, error:"Le mot après la virgule doit commencer par la lettre 'j'."};
          break;
        case 25:
          if(ans !== finalPhrase) return {ok:false, error:"Ce n'est pas encore la bonne phrase finale."};
          break;
      }
    }
    return {ok:true};
  }

  function updateRulesDisplay() {
    rulesContainer.innerHTML = "";
    for(let i=0; i <= step; i++) {
      const div = document.createElement("div");
      div.className = "rule-item" + (i === step ? " current" : "");
      div.textContent = `Règle ${i+1} : ${rules[i]}`;
      rulesContainer.appendChild(div);
    }
  }

  function updateStats() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    statsDiv.textContent = `Essais : ${attempts} | Temps écoulé : ${elapsed}s | Étape : ${step + 1}/${rules.length}`;
  }

  function flashBody(type) {
    if(type === "error") {
      document.body.classList.add("error-flash");
      playErrorSound();
      setTimeout(() => document.body.classList.remove("error-flash"), 900);
    } else if(type === "success") {
      document.body.classList.add("success-flash");
      playSuccessSound();
      setTimeout(() => document.body.classList.remove("success-flash"), 1200);
    }
  }

  // Confetti animation
  function launchConfetti() {
    const colors = ['#f0c040','#e94e77','#8cc8f8','#4caf50','#ff6f61'];
    for(let i=0; i<150; i++) {
      const confetti = document.createElement('div');
      confetti.classList.add('confetti-piece');
      confetti.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
      confetti.style.left = Math.random() * window.innerWidth + 'px';
      confetti.style.top = Math.random() * -50 + 'px';
      confetti.style.animationDuration = 2000 + Math.random()*3000 + 'ms';
      confetti.style.animationDelay = (Math.random()*1000) + 'ms';
      confetti.style.transform = `rotate(${Math.random()*360}deg)`;
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 4000);
    }
  }

  submitBtn.addEventListener("click", () => {
    const answer = answerInput.value;
    attempts++;
    const validation = validateAnswer(answer);
    if(validation.ok) {
      flashBody("success");
      messageDiv.textContent = `Règle ${step+1} validée ! 🎉`;
      messageDiv.className = "success";
      step++;
      updateRulesDisplay();
      updateStats();
      answerInput.value = "";
      if(step === rules.length) {
        messageDiv.textContent = "🎊 Bravo, tu as trouvé la phrase finale ! 🎊";
        launchConfetti();
        submitBtn.disabled = true;
        answerInput.disabled = true;
      }
    } else {
      flashBody("error");
      messageDiv.textContent = validation.error;
      messageDiv.className = "error";
    }
  });

  answerInput.addEventListener("keydown", e => {
    if(e.key === "Enter") submitBtn.click();
  });

  updateRulesDisplay();
  updateStats();

  // Timer update
  setInterval(updateStats, 1000);
})();
</script>

</body>
</html>
